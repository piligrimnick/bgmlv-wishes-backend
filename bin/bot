#!/usr/bin/env ruby
$stdout.sync = true
require_relative '../config/environment'

require 'telegram/bot'

token = ENV['TELEGRAM_TOKEN']

Telegram::Bot::Client.run(token, logger: Rails.logger) do |bot|
  bot.logger.info('Bot has been started')

  bot.listen do |message|
    Rails.application.reloader.wrap do
      result = Users::FindOrCreateFromTelegram.call(
        chat_id: message.chat.id,
        username: message.from.username,
        firstname: message.from.first_name,
        lastname: message.from.last_name
      )

      next unless result.success?
      
      user = result.value!

      next unless message.respond_to?(:text)

      case message.text
      when '/start'
        bot.api.send_message(chat_id: message.chat.id, text: "Hello, #{message.from.first_name}")
      when '/stop'
        bot.api.send_message(chat_id: message.chat.id, text: "Bye, #{message.from.first_name}")
      when '/share_link'
        bot.api.send_message(chat_id: message.chat.id, text: "https://wishes.bgmlv.com/profile/#{user.id}")
      when '/list'
        result = Wishes::Queries::ListWishes.call(
          filters: { user_id: user.id, state: :active }
        )

        if result.failure? || result.value!.blank?
          bot.api.send_message(chat_id: message.chat.id, text: 'У вас еще нет желаний :(')
          next
        end

        result.value!.each do |wish|
          bot.api.send_message(chat_id: message.chat.id, text: "#{wish.id}: #{wish.body} \n #{wish.url || ''}")
        end
      when /\/delete/
        wish_id = message.text.match(/\/delete (.*)/)[1]

        result = Wishes::Commands::DeleteWish.call(id: wish_id, filters: { user_id: user.id })

        if result.success?
          bot.api.send_message(chat_id: message.chat.id, text: "Желание удалено")
        else
          bot.api.send_message(chat_id: message.chat.id, text: "Ошибка удаления желания")
        end
      when /\/get/
        wish_id = message.text.match(/\/get (.*)/)[1]

        next if wish_id.blank?

        result = Wishes::Queries::FindWish.call(id: wish_id, filters: { user_id: user.id })

        if result.failure?
          bot.api.send_message(chat_id: message.chat.id, text: "Желания с таким ID не существует :(")
          next
        end

        wish = result.value!
        bot.api.send_message(chat_id: message.chat.id, text: "#{wish.body} \n #{wish.url || ''}")
      else
        result = Wishes::CreateFromTelegram.call(user: { id: user.id }, message_text: message.text)

        if result.success?
          bot.api.send_message(
            chat_id: message.chat.id,
            reply_to_message_id: message.message_id,
            text: "Желание сохранено с ID: #{result.value!.id} :)"
          )
        else
          bot.api.send_message(
            chat_id: message.chat.id,
            text: "Ошибка сохранения желания"
          )
        end
      end
    end
  end
  rescue Telegram::Bot::Exceptions::Base => e
    puts e
end
